<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimientos de Inventario - HP&K ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/vistas/shared/navigation.js"></script>
    <style>
        .dropdown-menu { display: none; }
        .dropdown.active .dropdown-menu { display: block; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Menu will be loaded here -->
    <div id="navigation-container"></div>

    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-exchange-alt text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Movimientos de Inventario</h1>
                        <p class="text-blue-200 text-sm">Control de Entradas y Salidas</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <a href="/index.html" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg transition">
                        <i class="fas fa-home"></i> Inicio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-6">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-exchange-alt text-cyan-600 mr-3"></i>
                        Movimientos de Inventario
                    </h1>
                    <p class="text-gray-600 mt-1">Registro de Entradas, Salidas y Transferencias</p>
                </div>
                <button onclick="showCreateForm()" class="bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 text-white px-6 py-3 rounded-lg shadow-lg transition flex items-center">
                    <i class="fas fa-plus mr-2"></i> Nuevo Movimiento
                </button>
            </div>
        </div>

        <div id="formSection" class="hidden bg-white rounded-lg shadow-lg p-6 mb-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-6" id="formTitle">Nuevo Movimiento</h3>
            <form id="movimientoForm" class="space-y-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-file-alt text-cyan-600 mr-2"></i>
                        Identificación del Movimiento
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Número Movimiento*</label>
                            <input type="text" id="numero_movimiento" required class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Movimiento*</label>
                            <select id="tipo_movimiento" required class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="">Seleccione...</option>
                                <option value="entrada">Entrada</option>
                                <option value="salida">Salida</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="ajuste">Ajuste de Inventario</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Movimiento*</label>
                            <input type="datetime-local" id="fecha_movimiento" required class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Folio/Referencia</label>
                            <input type="text" id="folio_referencia" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-box text-blue-600 mr-2"></i>
                        Inventario y Cantidad
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Inventario*</label>
                            <select id="material_id" required class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad*</label>
                            <input type="number" id="cantidad" required step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unidad de Medida*</label>
                            <select id="unidad_medida" required class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="">Seleccione...</option>
                                <option value="KG">KG</option>
                                <option value="LT">LT</option>
                                <option value="UN">UN</option>
                                <option value="CJ">CJ</option>
                                <option value="MT">MT</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-warehouse text-green-600 mr-2"></i>
                        Origen y Destino
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Almacén Origen</label>
                            <select id="almacen_origen_id" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Almacén Destino</label>
                            <select id="almacen_destino_id" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación Origen</label>
                            <input type="text" id="ubicacion_origen" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Ej: P-A1-N2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación Destino</label>
                            <input type="text" id="ubicacion_destino" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Ej: P-B2-N3">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-comment-alt text-purple-600 mr-2"></i>
                        Motivo y Documentación
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Motivo*</label>
                            <select id="motivo" required class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="">Seleccione...</option>
                                <option value="compra">Compra</option>
                                <option value="venta">Venta</option>
                                <option value="produccion">Producción</option>
                                <option value="devolucion">Devolución</option>
                                <option value="ajuste">Ajuste</option>
                                <option value="merma">Merma</option>
                                <option value="traslado">Traslado</option>
                                <option value="mantenimiento">Mantenimiento</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Documento</label>
                            <select id="tipo_documento" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="">Seleccione...</option>
                                <option value="OC">Orden de Compra</option>
                                <option value="GR">Guía de Remisión</option>
                                <option value="OP">Orden de Producción</option>
                                <option value="OT">Orden de Trabajo</option>
                                <option value="NE">Nota de Entrada</option>
                                <option value="NS">Nota de Salida</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Número Documento</label>
                            <input type="text" id="numero_documento" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Documento Adjunto</label>
                            <input type="file" id="documento_adjunto" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-dollar-sign text-orange-600 mr-2"></i>
                        Costos
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Costo Unitario</label>
                            <input type="number" id="costo_unitario" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Costo Total</label>
                            <input type="number" id="costo_total" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Moneda</label>
                            <select id="moneda" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="USD">USD - Dólar</option>
                                <option value="PEN">PEN - Sol</option>
                                <option value="EUR">EUR - Euro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-barcode text-teal-600 mr-2"></i>
                        Trazabilidad
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lote</label>
                            <input type="text" id="lote" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Número de Serie</label>
                            <input type="text" id="numero_serie" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Vencimiento</label>
                            <input type="date" id="fecha_vencimiento" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-user-shield text-indigo-600 mr-2"></i>
                        Responsable y Estado
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Responsable*</label>
                            <input type="text" id="responsable" required class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Aprobador</label>
                            <input type="text" id="aprobador" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estado*</label>
                            <select id="estado" required class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                <option value="pendiente">Pendiente</option>
                                <option value="en_proceso">En Proceso</option>
                                <option value="completado">Completado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-sticky-note text-amber-600 mr-2"></i>
                        Observaciones
                    </h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notas Adicionales</label>
                        <textarea id="observaciones" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Detalles adicionales del movimiento..."></textarea>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-user text-pink-600 mr-2"></i>
                        Usuario
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">User_crea</label>
                            <input type="text" id="user_crea" readonly class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Creación</label>
                            <input type="datetime-local" id="fecha_creacion" readonly class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100">
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-lg shadow-lg transition flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> Guardar
                    </button>
                    <button type="button" onclick="cancelForm()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-lg shadow-lg transition flex items-center justify-center">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <input type="text" id="searchInput" placeholder="Buscar movimiento..." onkeyup="filterTable()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                <select id="filterTipo" onchange="filterTable()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                    <option value="">Todos los Tipos</option>
                    <option value="entrada">Entrada</option>
                    <option value="salida">Salida</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="ajuste">Ajuste</option>
                </select>
                <select id="filterEstado" onchange="filterTable()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                    <option value="">Todos los Estados</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="en_proceso">En Proceso</option>
                    <option value="completado">Completado</option>
                </select>
                <input type="date" id="filterFecha" onchange="filterTable()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                <button onclick="clearFilters()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-redo mr-2"></i> Limpiar
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Número</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Fecha</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Tipo</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Inventario</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Cantidad</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Origen → Destino</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Estado</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast" class="hidden fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 text-white">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        let movimientos = [];
        let editingId = null;

        // Dropdown functions are now handled by NavigationManager

        document.addEventListener('DOMContentLoaded', () => {
            loadMovimientos();
            loadCatalogos();
            document.getElementById('user_crea').value = 'Admin';
            document.getElementById('cantidad').addEventListener('input', calcularCosto);
            document.getElementById('costo_unitario').addEventListener('input', calcularCosto);
        });

        function calcularCosto() {
            const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
            const costoUnitario = parseFloat(document.getElementById('costo_unitario').value) || 0;
            const total = cantidad * costoUnitario;
            document.getElementById('costo_total').value = total.toFixed(2);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        async function loadCatalogos() {
            try {
                const almacenes = await fetch('/api/logistica/almacenes').then(r => r.json());
                
                const matSelect = document.getElementById('material_id');
                matSelect.innerHTML = '<option value="">Seleccione inventario...</option>';
                // Materials endpoint not available yet
                
                const almOrigenSelect = document.getElementById('almacen_origen_id');
                const almDestinoSelect = document.getElementById('almacen_destino_id');
                almOrigenSelect.innerHTML = '<option value="">Seleccione almacén...</option>';
                almDestinoSelect.innerHTML = '<option value="">Seleccione almacén...</option>';
                almacenes.forEach(a => {
                    almOrigenSelect.innerHTML += `<option value="${a.id}">${a.nombre}</option>`;
                    almDestinoSelect.innerHTML += `<option value="${a.id}">${a.nombre}</option>`;
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadMovimientos() {
            try {
                const response = await fetch('/api/logistica/movimientos');
                movimientos = await response.json();
                renderTable();
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al cargar movimientos', 'error');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            movimientos.forEach(mov => {
                const origen = mov.almacen_origen_nombre || '-';
                const destino = mov.almacen_destino_nombre || '-';
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 text-sm font-semibold">${mov.numero_movimiento || '-'}</td>
                        <td class="px-6 py-4 text-sm">${mov.fecha_movimiento ? new Date(mov.fecha_movimiento).toLocaleString('es-PE') : '-'}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-bold rounded ${getTipoColor(mov.tipo_movimiento)}">${mov.tipo_movimiento || '-'}</span></td>
                        <td class="px-6 py-4 text-sm">${mov.material_nombre || '-'}</td>
                        <td class="px-6 py-4 text-sm font-bold">${mov.cantidad || 0} ${mov.unidad_medida || ''}</td>
                        <td class="px-6 py-4 text-sm">${origen} → ${destino}</td>
                        <td class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold rounded-full ${getEstadoColor(mov.estado)}">${mov.estado || 'pendiente'}</span></td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="editMovimiento(${mov.id})" class="text-blue-600 hover:text-blue-800 mx-1"><i class="fas fa-edit"></i></button>
                            <button onclick="viewDetails(${mov.id})" class="text-purple-600 hover:text-purple-800 mx-1" title="Ver Detalles"><i class="fas fa-eye"></i></button>
                            <button onclick="deleteMovimiento(${mov.id})" class="text-red-600 hover:text-red-800 mx-1"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function getTipoColor(tipo) {
            const colors = {'entrada': 'bg-green-100 text-green-800', 'salida': 'bg-red-100 text-red-800', 'transferencia': 'bg-blue-100 text-blue-800', 'ajuste': 'bg-yellow-100 text-yellow-800'};
            return colors[tipo] || 'bg-gray-100 text-gray-800';
        }

        function getEstadoColor(estado) {
            const colors = {'pendiente': 'bg-gray-100 text-gray-800', 'en_proceso': 'bg-blue-100 text-blue-800', 'completado': 'bg-green-100 text-green-800', 'cancelado': 'bg-red-100 text-red-800'};
            return colors[estado] || 'bg-gray-100 text-gray-800';
        }

        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const tipo = document.getElementById('filterTipo').value;
            const estado = document.getElementById('filterEstado').value;
            const fecha = document.getElementById('filterFecha').value;
            document.querySelectorAll('#tableBody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                const match = text.includes(search) && (!tipo || text.includes(tipo)) && (!estado || text.includes(estado)) && (!fecha || text.includes(fecha));
                row.style.display = match ? '' : 'none';
            });
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterEstado').value = '';
            document.getElementById('filterFecha').value = '';
            filterTable();
        }

        function showCreateForm() {
            editingId = null;
            document.getElementById('formSection').classList.remove('hidden');
            document.getElementById('formTitle').textContent = 'Nuevo Movimiento';
            document.getElementById('movimientoForm').reset();
            document.getElementById('user_crea').value = 'Admin';
            document.getElementById('fecha_creacion').value = new Date().toISOString().slice(0, 16);
            document.getElementById('fecha_movimiento').value = new Date().toISOString().slice(0, 16);
            document.getElementById('estado').value = 'pendiente';
            document.getElementById('moneda').value = 'USD';
        }

        function cancelForm() {
            document.getElementById('formSection').classList.add('hidden');
        }

        function editMovimiento(id) {
            const mov = movimientos.find(m => m.id === id);
            if (!mov) return;
            editingId = id;
            document.getElementById('formSection').classList.remove('hidden');
            document.getElementById('formTitle').textContent = 'Editar Movimiento';
            document.getElementById('numero_movimiento').value = mov.numero_movimiento || '';
            document.getElementById('tipo_movimiento').value = mov.tipo_movimiento || '';
            document.getElementById('fecha_movimiento').value = mov.fecha_movimiento || '';
            document.getElementById('material_id').value = mov.material_id || '';
            document.getElementById('cantidad').value = mov.cantidad || '';
            document.getElementById('almacen_origen_id').value = mov.almacen_origen_id || '';
            document.getElementById('almacen_destino_id').value = mov.almacen_destino_id || '';
            document.getElementById('estado').value = mov.estado || '';
            calcularCosto();
        }

        function viewDetails(id) {
            alert('Ver detalles del movimiento #' + id);
        }

        async function deleteMovimiento(id) {
            if (!confirm('¿Eliminar este movimiento?')) return;
            try {
                const response = await fetch(`/api/logistica/movimientos/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    showToast('Movimiento eliminado', 'success');
                    loadMovimientos();
                } else {
                    showToast('Error al eliminar', 'error');
                }
            } catch (error) {
                showToast('Error al eliminar', 'error');
            }
        }

        document.getElementById('movimientoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                numero_movimiento: document.getElementById('numero_movimiento').value,
                tipo_movimiento: document.getElementById('tipo_movimiento').value,
                fecha_movimiento: document.getElementById('fecha_movimiento').value,
                folio_referencia: document.getElementById('folio_referencia').value || null,
                material_id: parseInt(document.getElementById('material_id').value),
                cantidad: parseFloat(document.getElementById('cantidad').value),
                unidad_medida: document.getElementById('unidad_medida').value,
                almacen_origen_id: document.getElementById('almacen_origen_id').value ? parseInt(document.getElementById('almacen_origen_id').value) : null,
                almacen_destino_id: document.getElementById('almacen_destino_id').value ? parseInt(document.getElementById('almacen_destino_id').value) : null,
                ubicacion_origen: document.getElementById('ubicacion_origen').value || null,
                ubicacion_destino: document.getElementById('ubicacion_destino').value || null,
                motivo: document.getElementById('motivo').value,
                tipo_documento: document.getElementById('tipo_documento').value || null,
                numero_documento: document.getElementById('numero_documento').value || null,
                costo_unitario: parseFloat(document.getElementById('costo_unitario').value) || null,
                costo_total: parseFloat(document.getElementById('costo_total').value) || null,
                moneda: document.getElementById('moneda').value,
                lote: document.getElementById('lote').value || null,
                numero_serie: document.getElementById('numero_serie').value || null,
                fecha_vencimiento: document.getElementById('fecha_vencimiento').value || null,
                responsable: document.getElementById('responsable').value,
                aprobador: document.getElementById('aprobador').value || null,
                estado: document.getElementById('estado').value,
                observaciones: document.getElementById('observaciones').value || null,
                user_crea: document.getElementById('user_crea').value
            };
            
            try {
                const url = editingId ? `/api/logistica/movimientos/${editingId}` : '/api/logistica/movimientos';
                const response = await fetch(url, {
                    method: editingId ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showToast(editingId ? 'Movimiento actualizado' : 'Movimiento creado', 'success');
                    cancelForm();
                    loadMovimientos();
                } else {
                    showToast('Error al guardar', 'error');
                }
            } catch (error) {
                showToast('Error al guardar', 'error');
            }
        });
    </script>
</body>
</html>
